# Fix Primary Key Constraint Violation

## ðŸš¨ Masalah yang Terjadi

**Error:** `Violation of PRIMARY KEY constraint 'PK__sia_trcu__AD647D8F5070F446'. Cannot insert duplicate key in object 'dbo.sia_mscutiakademik'. The duplicate key value is (10).`

**Penyebab:**
1. Logika pembuatan ID draft menggunakan stored procedure yang tidak reliable
2. Ada race condition saat multiple user membuat draft bersamaan
3. ID yang di-generate bisa bentrok dengan ID yang sudah ada

## âœ… Solusi yang Diterapkan

### 1. Bypass Stored Procedure untuk Draft
- **Sebelum**: Menggunakan SP `sia_createCutiAkademik` yang bisa generate ID bentrok
- **Sesudah**: Insert langsung ke tabel dengan ID yang di-generate secara aman

### 2. Generate Unique ID dengan Retry Mechanism
```csharp
private async Task<string> GenerateUniqueDraftIdAsync(SqlConnection conn)
{
    for (int attempt = 0; attempt < 10; attempt++)
    {
        // Generate ID berdasarkan timestamp + random
        var timestamp = DateTimeOffset.Now.ToUnixTimeSeconds();
        var random = new Random().Next(100, 999);
        var candidateId = $"{timestamp}{random}";

        // Cek apakah ID sudah ada
        var checkCmd = new SqlCommand("SELECT COUNT(*) FROM sia_mscutiakademik WHERE cak_id = @id", conn);
        checkCmd.Parameters.AddWithValue("@id", candidateId);

        var count = (int)await checkCmd.ExecuteScalarAsync();
        if (count == 0)
        {
            return candidateId;
        }
    }

    // Fallback: gunakan GUID jika semua attempt gagal
    return Guid.NewGuid().ToString("N")[..10];
}
```

### 3. Exception Handling untuk Primary Key Violation
```csharp
try
{
    await cmd.ExecuteNonQueryAsync();
    return newDraftId;
}
catch (SqlException ex) when (ex.Number == 2627) // Primary key violation
{
    // Jika masih ada collision, coba generate ID baru
    newDraftId = await GenerateUniqueDraftIdAsync(conn);
    cmd.Parameters["@cak_id"].Value = newDraftId;
    await cmd.ExecuteNonQueryAsync();
    return newDraftId;
}
```

## ðŸ”§ Method yang Diperbaiki

### 1. CreateDraftAsync (Mahasiswa)
- âœ… Generate unique ID dengan timestamp + random
- âœ… Insert langsung ke tabel
- âœ… Retry mechanism jika ada collision
- âœ… File handling yang aman

### 2. CreateDraftByProdiAsync (Prodi)
- âœ… Generate unique ID dengan timestamp + random
- âœ… Insert langsung ke tabel
- âœ… Retry mechanism jika ada collision
- âœ… Support field tambahan (menimbang, approval_prodi)

## ðŸŽ¯ Keuntungan Solusi Ini

1. **Thread-Safe**: ID generation aman untuk concurrent access
2. **Unique ID**: Kombinasi timestamp + random sangat kecil kemungkinan bentrok
3. **Retry Mechanism**: Jika ada collision, otomatis generate ID baru
4. **Fallback**: Jika semua attempt gagal, gunakan GUID
5. **Performance**: Lebih cepat karena tidak perlu SP untuk draft

## ðŸ“‹ Format ID yang Dihasilkan

### Draft ID Format
- **Pattern**: `{timestamp}{random}`
- **Contoh**: `1703123456789123` (timestamp: 1703123456789, random: 123)
- **Length**: 13-16 karakter
- **Uniqueness**: Sangat tinggi karena kombinasi waktu + random

### Final ID Format (setelah generate)
- **Pattern**: `XXX/PMA/CA/MM/YYYY`
- **Contoh**: `012/PMA/CA/IX/2025`
- **Generated by**: Stored procedure saat STEP2

## ðŸ§ª Testing

### Test Case 1: Single User
```bash
POST /api/CutiAkademik/draft
# Expected: Berhasil dengan ID unik
```

### Test Case 2: Multiple Concurrent Users
```bash
# Simulasi 10 user bersamaan
for i in {1..10}; do
  curl -X POST /api/CutiAkademik/draft &
done
# Expected: Semua berhasil dengan ID berbeda
```

### Test Case 3: High Load
```bash
# Simulasi 100 request dalam 1 detik
# Expected: Tidak ada primary key violation
```

## ðŸš€ Cara Testing Setelah Fix

1. **Restart aplikasi**:
   ```bash
   dotnet run
   ```

2. **Test via Swagger**:
   - Buka `http://localhost:5234/swagger`
   - Pilih `POST /api/CutiAkademik/draft`
   - Isi form dengan data test
   - Klik Execute

3. **Expected Result**:
   ```json
   {
     "draftId": "1703123456789123"
   }
   ```

4. **Test Multiple Times**:
   - Coba POST beberapa kali berturut-turut
   - Setiap kali harus berhasil dengan ID berbeda
   - Tidak boleh ada error primary key violation

## ðŸ“ Catatan Penting

1. **ID Draft vs Final ID**:
   - Draft ID: Numeric string (timestamp-based)
   - Final ID: Format PMA setelah di-generate

2. **Backward Compatibility**:
   - Method lain (GenerateId, Update, Delete) tetap menggunakan SP
   - Hanya draft creation yang di-bypass

3. **Database Schema**:
   - Tidak ada perubahan struktur tabel
   - Hanya cara insert yang berubah

4. **File Handling**:
   - File tetap di-save dengan GUID filename
   - Path: `wwwroot/uploads/cuti/`